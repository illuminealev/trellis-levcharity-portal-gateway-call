---
- name: Authenticate with LevCharity Portal API
  uri:
    url: "https://portal.levcharity.com/api/v1/auth/token"
    method: POST
    headers:
      Accept: "application/json"
      Content-Type: "application/json"
    body_format: json
    body:
      email: "{{ lookup('env', 'levcharity_portal_api_client_email_' + env) }}"
      password: "{{ lookup('env', 'levcharity_portal_api_client_password_' + env) }}"
    status_code: 200
    timeout: 30
  register: auth_result
  no_log: true
  retries: 3
  delay: 5
  failed_when: auth_result.status != 200

- name: Set access token from authentication response
  set_fact:
    access_token: "{{ auth_result.json.access_token }}"

- name: Verify access token was received
  fail:
    msg: "Failed to get access token from LevCharity Portal API"
  when: access_token is not defined or access_token == ""

- name: Get project keys from LevCharity Portal API
  uri:
    url: "https://portal.levcharity.com/api/v1/gateway/{{ lookup('env', 'levcharity_portal_api_client_id_' + env) }}"
    method: GET
    headers:
      Accept: "application/json"
      Authorization: "Bearer {{ access_token }}"
    status_code: 200
    timeout: 30
  register: keys_result
  no_log: false
  retries: 3
  delay: 5
  failed_when: keys_result.status != 200

- name: Set project keys from API response
  set_fact:
    project_keys: "{{ keys_result.json.keys }}"

- name: Verify project keys were received
  fail:
    msg: "Failed to get project keys from LevCharity Portal API"
  when: project_keys is not defined or project_keys | length == 0

- name: Initialize validation payload
  set_fact:
    validation_payload:
      validations: []

- name: Build validation payload for all keys
  set_fact:
    validation_payload:
      validations: "{{ validation_payload.validations + [{'key': item, 'value': lookup('env', item | upper)}] }}"
  loop: "{{ project_keys }}"

- name: Validate all project keys at once
  uri:
    url: "https://portal.levcharity.com/api/v1/gateway/{{ lookup('env', 'levcharity_portal_api_client_id_' + env) }}/validate/all"
    method: POST
    headers:
      Accept: "application/json"
      Content-Type: "application/json"
      Authorization: "Bearer {{ access_token }}"
    body_format: json
    body: "{{ validation_payload }}"
    status_code: 200
    timeout: 30
  register: validation_result
  no_log: true
  retries: 3
  delay: 5
  failed_when: validation_result.status != 200

- name: Check validation result
  fail:
    msg: "Key validation failed. Response: {{ validation_result.json | default('No response data') }}"
  when: validation_result.json.status != "success"

- name: Display successful validation message
  debug:
    msg: "All {{ project_keys | length }} keys have been successfully validated with LevCharity Portal API"
