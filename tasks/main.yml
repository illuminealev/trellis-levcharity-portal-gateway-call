---
- name: Debug environment variables
  debug:
    msg:
      - "Environment: {{ env }}"
      - "Email env var: levcharity_portal_api_client_email_{{ env }}"
      - "Password env var: levcharity_portal_api_client_password_{{ env }}"
      - "Project ID env var: levcharity_portal_api_client_id_{{ env }}"
      - "Email value: {{ lookup('env', 'levcharity_portal_api_client_email_' + env) | default('NOT_SET') }}"
      - "Password value: {{ lookup('env', 'levcharity_portal_api_client_password_' + env) | default('NOT_SET') }}"
      - "Project ID value: {{ lookup('env', 'levcharity_portal_api_client_id_' + env) | default('NOT_SET') }}"

- name: Check if required environment variables are set
  fail:
    msg: "Required environment variable '{{ item }}' is not set for environment '{{ env }}'"
  when: lookup('env', item) == ""
  loop:
    - "levcharity_portal_api_client_email_{{ env }}"
    - "levcharity_portal_api_client_password_{{ env }}"
    - "levcharity_portal_api_client_id_{{ env }}"

- name: Authenticate with LevCharity Portal API
  uri:
    url: "https://portal.levcharity.com/api/v1/auth/token"
    method: POST
    headers:
      Accept: "application/json"
      Content-Type: "application/json"
    body_format: json
    body:
      email: "{{ lookup('env', 'levcharity_portal_api_client_email_' + env) }}"
      password: "{{ lookup('env', 'levcharity_portal_api_client_password_' + env) }}"
    status_code: 200
    timeout: 30
  register: auth_result
  retries: 3
  delay: 5
  failed_when: auth_result.status != 200

- name: Debug authentication response
  debug:
    msg: "Authentication response status: {{ auth_result.status }}, Response: {{ auth_result.json | default('No JSON response') }}"
  when: auth_result.status != 200

- name: Set access token from authentication response
  set_fact:
    access_token: "{{ auth_result.json.access_token }}"

- name: Verify access token was received
  fail:
    msg: "Failed to get access token from LevCharity Portal API. Response: {{ auth_result.json | default('No response data') }}"
  when: access_token is not defined or access_token == ""

- name: Get project keys from LevCharity Portal API
  uri:
    url: "https://portal.levcharity.com/api/v1/gateway/{{ lookup('env', 'levcharity_portal_api_client_id_' + env) }}"
    method: GET
    headers:
      Accept: "application/json"
      Authorization: "Bearer {{ access_token }}"
    status_code: 200
    timeout: 30
  register: keys_result
  retries: 3
  delay: 5
  failed_when: keys_result.status != 200

- name: Set project keys from API response
  set_fact:
    project_keys: "{{ keys_result.json.keys }}"

- name: Verify project keys were received
  fail:
    msg: "Failed to get project keys from LevCharity Portal API"
  when: project_keys is not defined or project_keys | length == 0

- name: Validate each project key individually
  uri:
    url: "https://portal.levcharity.com/api/v1/gateway/{{ lookup('env', 'levcharity_portal_api_client_id_' + env) }}/validate"
    method: POST
    headers:
      Accept: "application/json"
      Content-Type: "application/json"
      Authorization: "Bearer {{ access_token }}"
    body_format: json
    body:
      key: "{{ item }}"
      value: "{{ lookup('env', item | upper) }}"
    status_code: 200
    timeout: 30
  register: validation_result
  retries: 3
  delay: 5
  failed_when: validation_result.status != 200
  loop: "{{ project_keys }}"

- name: Check validation result for each key
  fail:
    msg: "Key validation failed for '{{ item.item }}'. Response: {{ item.json | default('No response data') }}"
  when: item.json.status != "success"
  loop: "{{ validation_result.results }}"

- name: Display successful validation message
  debug:
    msg: "All {{ project_keys | length }} keys have been successfully validated with LevCharity Portal API"
